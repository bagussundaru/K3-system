// Prisma Schema for K3 (Keselamatan dan Kesehatan Kerja) Enterprise System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// WORKER MANAGEMENT
// ============================================

model Worker {
  id              String   @id @default(cuid())
  employeeId      String   @unique // Nomor karyawan
  name            String
  department      String
  position        String
  shiftId         String?
  shift           Shift?   @relation(fields: [shiftId], references: [id])
  email           String?
  phone           String?
  dateOfBirth     DateTime?
  bloodType       String? // Golongan darah
  emergencyContact String?
  emergencyPhone   String?
  medicalConditions String? // Kondisi medis khusus
  photo           String? // URL foto pekerja
  isActive        Boolean  @default(true)
  joinedAt        DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  deviceAssignments DeviceAssignment[]
  incidents        Incident[]
  alerts           Alert[]

  @@index([department])
  @@index([shiftId])
}

// ============================================
// SHIFT MANAGEMENT
// ============================================

model Shift {
  id          String   @id @default(cuid())
  name        String   // Pagi, Siang, Malam
  startTime   String   // "07:00"
  endTime     String   // "15:00"
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workers Worker[]

  @@index([isActive])
}

// ============================================
// ZONE/AREA MANAGEMENT
// ============================================

model Zone {
  id          String   @id @default(cuid())
  name        String   // e.g., "Zona Produksi A"
  code        String   @unique // e.g., "ZPA-001"
  type        ZoneType // PRODUCTION, WAREHOUSE, OFFICE, CONFINED_SPACE, OUTDOOR
  description String?
  temperatureThreshold   Float? // Suhu maksimal (Â°C)
  humidityThreshold     Float? // Kelembaban maksimal (%)
  gasThresholdNH3       Float? // Amonia (PPM)
  gasThresholdCO        Float? // Karbon Monoksida (PPM)
  requiredPPE           String? // Alat Pelindung Diri yang wajib (JSON array)
  isRestricted          Boolean @default(false)
  maxWorkers            Int? // Maksimal jumlah pekerja
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  deviceAssignments DeviceAssignment[]
  incidents        Incident[]

  @@index([type])
  @@index([isRestricted])
}

enum ZoneType {
  PRODUCTION
  WAREHOUSE
  OFFICE
  CONFINED_SPACE
  OUTDOOR
  MAINTENANCE
  LOADING_DOCK
}

// ============================================
// DEVICE MANAGEMENT
// ============================================

model Device {
  id            String      @id @default(cuid())
  serialNumber  String      @unique
  name          String
  type          DeviceType
  model         String?     // e.g., "ESP32-WROOM", "ESP32-C3"
  firmwareVersion String?
  status        DeviceStatus
  batteryLevel  Int?        // 0-100
  lastHeartbeat DateTime?
  location      String?     // Koordinat GPS atau deskripsi lokasi
  ipAddress     String?
  macAddress    String?
  calibrationDate DateTime?
  notes         String?
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  assignments       DeviceAssignment[]
  sensorReadings    SensorReading[]
  alerts            Alert[]

  @@index([type])
  @@index([status])
  @@index([isActive])
}

enum DeviceType {
  SAFE_GUARD      // Wearable Safety Tracker
  ENVIRO_SENSE    // Environmental Sensor
  SITE_SECURE     // Perimeter Access Control with AI
}

enum DeviceStatus {
  ONLINE
  OFFLINE
  LOW_BATTERY
  ERROR
  CALIBRATING
  MAINTENANCE
}

// ============================================
// DEVICE ASSIGNMENT
// ============================================

model DeviceAssignment {
  id          String   @id @default(cuid())
  deviceId    String
  device      Device   @relation(fields: [deviceId], references: [id])
  workerId    String?
  worker      Worker?  @relation(fields: [workerId], references: [id])
  zoneId      String?
  zone        Zone?    @relation(fields: [zoneId], references: [id])
  assignedAt  DateTime @default(now())
  returnedAt  DateTime?
  isAssigned  Boolean  @default(true)
  notes       String?

  @@unique([deviceId, isAssigned])
  @@index([workerId])
  @@index([zoneId])
}

// ============================================
// SENSOR READINGS
// ============================================

model SensorReading {
  id          String   @id @default(cuid())
  deviceId    String
  device      Device   @relation(fields: [deviceId], references: [id])
  type        SensorType
  value       Float
  unit        String
  timestamp   DateTime @default(now())
  metadata    String?  // Additional data in JSON format

  @@index([deviceId])
  @@index([type])
  @@index([timestamp])
}

enum SensorType {
  // SafeGuard (Wearable)
  HEART_RATE
  SPO2
  RMSSD          // Heart Rate Variability for fatigue detection
  ACCELERATION_X
  ACCELERATION_Y
  ACCELERATION_Z
  ACTIVITY_LEVEL
  FALL_DETECTED
  SOS_TRIGGERED

  // EnviroSense (Environmental)
  AMMONIA_NH3
  CARBON_MONOXIDE_CO
  LPG
  PROPANE
  BENZENE
  SULFIDE
  TEMPERATURE
  HUMIDITY
  AIR_QUALITY_INDEX

  // SiteSecure (Vision AI)
  PPE_COMPLIANCE
  HELMET_DETECTED
  VEST_DETECTED
  BOOTS_DETECTED
  UNAUTHORIZED_ACCESS
  FACE_DETECTED
}

// ============================================
// ALERT MANAGEMENT
// ============================================

model Alert {
  id          String     @id @default(cuid())
  deviceId    String
  device      Device     @relation(fields: [deviceId], references: [id])
  workerId    String?
  worker      Worker?    @relation(fields: [workerId], references: [id])
  type        AlertType
  severity    AlertSeverity
  title       String
  description String
  value       Float?     // Nilai yang memicu alert
  threshold   Float?     // Ambang batas yang dilanggar
  status      AlertStatus
  acknowledgedAt DateTime?
  acknowledgedBy String?
  resolvedAt   DateTime?
  resolvedBy   String?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([deviceId])
  @@index([workerId])
  @@index([type])
  @@index([severity])
  @@index([status])
  @@index([createdAt])
}

enum AlertType {
  FATIGUE_HIGH
  HEART_RATE_HIGH
  HEART_RATE_LOW
  SPO2_LOW
  FALL_DETECTED
  SOS_EMERGENCY
  WORKER_IMMOBILE

  GAS_AMMONIA_HIGH
  GAS_CO_HIGH
  GAS_LPG_HIGH
  TEMPERATURE_HIGH
  HUMIDITY_HIGH
  AIR_QUALITY_POOR

  PPE_MISSING_HELMET
  PPE_MISSING_VEST
  PPE_MISSING_BOOTS
  UNAUTHORIZED_ACCESS
  MULTIPLE_PERSONS_DETECTED

  DEVICE_OFFLINE
  DEVICE_LOW_BATTERY
  DEVICE_ERROR
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AlertStatus {
  OPEN
  ACKNOWLEDGED
  RESOLVED
  DISMISSED
}

// ============================================
// INCIDENT MANAGEMENT
// ============================================

model Incident {
  id          String       @id @default(cuid())
  incidentNumber String    @unique // e.g., "INC-2025-001"
  workerId    String?
  worker      Worker?      @relation(fields: [workerId], references: [id])
  zoneId      String?
  zone        Zone?        @relation(fields: [zoneId], references: [id])
  type        IncidentType
  severity    IncidentSeverity
  title       String
  description String
  cause       String?      // Penyebab kejadian
  witnesses   String?      // JSON array of witness names
  photos      String?      // JSON array of photo URLs
  status      IncidentStatus
  reportedBy  String?
  reportedAt  DateTime     @default(now())
  resolvedAt  DateTime?
  resolvedBy  String?
  actionTaken String?      // Tindakan yang diambil
  preventionAction String? // Tindakan pencegahan
  medicalAttention Boolean @default(false)
  medicalNotes String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([workerId])
  @@index([zoneId])
  @@index([type])
  @@index([severity])
  @@index([status])
  @@index([reportedAt])
}

enum IncidentType {
  ACCIDENT
  INJURY
  NEAR_MISS
  ILLNESS
  FIRE
  GAS_LEAK
  EQUIPMENT_FAILURE
  FALL
  ELECTRIC_SHOCK
  CHEMICAL_EXPOSURE
  HEAT_STRESS
  OTHER
}

enum IncidentSeverity {
  MINOR
  MODERATE
  MAJOR
  FATAL
}

enum IncidentStatus {
  REPORTED
  UNDER_INVESTIGATION
  RESOLVED
  CLOSED
}

// ============================================
// COMPLIANCE RECORDS (Permenaker 5/2018)
// ============================================

model ComplianceRecord {
  id          String           @id @default(cuid())
  type        ComplianceType
  period      String           // e.g., "2025-01", "Q1-2025"
  zoneId      String?
  standard    String           // e.g., "Permenaker 5/2018", "ISO 45001"
  parameter   String           // e.g., "Amonia", "CO", "Suhu", "Sirkulasi Udara"
  threshold   Float            // Nilai ambang batas
  measuredValue Float?
  isCompliant Boolean
  notes       String?
  generatedBy String
  generatedAt DateTime         @default(now())

  @@index([type])
  @@index([period])
  @@index([standard])
  @@index([isCompliant])
}

enum ComplianceType {
  AIR_QUALITY
  TEMPERATURE
  HUMIDITY
  LIGHTING
  NOISE_LEVEL
  VENTILATION
  CHEMICAL_EXPOSURE
  PPE_COMPLIANCE
  WORKING_HOURS
  MEDICAL_CHECKUP
  SAFETY_TRAINING
}

// ============================================
// ANALYTICS & SUMMARY
// ============================================

model DailySummary {
  id            String   @id @default(cuid())
  date          DateTime
  totalWorkers  Int
  activeWorkers Int
  totalAlerts   Int
  criticalAlerts Int
  totalIncidents Int
  avgFatigueScore Float?
  avgAirQuality   Float?
  avgTemperature  Float?
  avgHumidity     Float?
  ppeComplianceRate Float?
  createdAt     DateTime @default(now())

  @@unique([date])
  @@index([date])
}

// ============================================
// SYSTEM SETTINGS
// ============================================

model SystemSettings {
  id                        String   @id @default(cuid())
  key                       String   @unique
  value                     String
  description               String?
  updatedAt                 DateTime @updatedAt
}

// ============================================
// MAINTAIN EXISTING USER/POST MODELS
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Post {
  id        String   @id @default(cuid())
  title     String
  content   String?
  published Boolean  @default(false)
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
